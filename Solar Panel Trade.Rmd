---
title: "US CHINA TRADE"
author: "PEIZHI ZHANG, Hanyi Wang, Xinyi Shi, Huiling Zhou"
date: "2023-04-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup}
library(ggplot2)
library(dplyr)
library(scales)
library(plotly)
library(DT)
library(tidyverse)
library(ggrepel)
library(readr)
library(data.table)



```

## R Markdown



```{r}
CN_US_cleaned_all <- read.csv("C:/Users/shixy/OneDrive/桌面/QMSS/4 Data Visualization/CN_US_cleaned_all.csv")
subset <- CN_US_cleaned_all[grep("^8541", CN_US_cleaned_all$HS6code),]


plot_data <- subset %>%
  group_by(period) %>%
  summarise(total_balance_primaryvalue = sum(balance_primaryValue),
            total_balance_qty = sum(balance_qty)) %>%
  mutate(primary_value_label = paste("Period: ", period, "<br> Balance Primary Value: ",
                                     round(total_balance_primaryvalue*10^(-3),2), " (thousands USD)"),
         qty_label = paste("Period: ", period, "<br> Balance Quantity: ",
                            round(total_balance_qty*10^(-4), 2), " (ten thousands units)"))

plot1 <- ggplot(plot_data, aes(x = period)) +
  geom_line(aes(y = total_balance_primaryvalue*10^(-3), color = "Total Balance Primary Value (thousands USD)"), size = 1.5) +
  geom_point(aes(y = total_balance_primaryvalue*10^(-3), color = "Total Balance Primary Value (thousands USD)", text = primary_value_label), size = 3) +
  geom_line(aes(y = total_balance_qty*10^(-4), color = "Total Balance Quantity (ten thousands units)"), size = 1.5) +
  geom_point(aes(y = total_balance_qty*10^(-4), color = "Total Balance Quantity (ten thousands units)", text = qty_label), size = 3) +
  scale_color_manual(values = c("green", "blue")) +
  scale_y_continuous(name = "Total Balance", labels = scales::comma) +
  labs(x = "Year", y = "Total balance primary value (thousands USD)") +
  ggtitle("China vs. US: Balance Primary Value and Quantity per Year(2017-21)") +
  theme_minimal() +
  theme(axis.title = element_text(size = 16),
        plot.title = element_text(size = 18),
        panel.grid.major = element_line(color = "gray", linetype = "dashed"),
        legend.position = "bottom",
        legend.direction = "vertical") +
  labs(caption = "Source: CN_US_cleaned_all dataset")
  
ggplotly(plot1, tooltip = c("text"), colors = c("Total Balance Primary Value (thousands USD)" = "green", "Total Balance Quantity (ten thousands unit)" = "blue"))

plotly_fig <- ggplotly(plot1, tooltip = c("text"), colors = c("Total Balance Primary Value (thousands USD)" = "green", "Total Balance Quantity (ten thousands units)" = "blue"))

plotly_fig <- plotly_fig %>% layout(legend = list(x = 0.2, y = -0.4))

plotly_fig


```




## Import Solar Panel Trade Text

```{r, message = FALSE, warning = FALSE, error=FALSE, echo=FALSE}

setwd("/Users/peizhi/Documents/Data Visualization/")

file_paths <- list.files("tradetext", pattern = ".txt", full.names = TRUE)

tradedata <- lapply(file_paths, readLines) %>% unlist() %>% data.frame(text = .)


```

## Clean text data

```{r, message = FALSE, warning = FALSE, error=FALSE, echo=FALSE}

library(tm)
library(SnowballC)
library(wordcloud)
library(tidytext)
library(tidyverse)

new_stops <- c("room","one","stop","minutes","nearby","listing","br","equipped","building","just","can","size","prior","welcome","ave","away","will","aside","except","month","home","bedroom","bathroom","two","three","apartment","unit","area","'ll","place","located","blocks","couple","plus","restaurants","shops","must","like","surrounded","daily","will","provide","without","within","spacebbr","bthe","nycbr","nyc","years","looking","information","give","makes","street","ny","city","quite","come","also","likebr","people","giving","five","behind","need","allow","space","next","world","stay","single","kitchen","guest","ride","min","citi","cit", "cinemat", "cinco", "chunk","circl","access","accessbbr","accomodation","accomod","air","amaz","footnote","citation","moreover",
               "beside","on","also","including","if","article","then","likely","such","as","requires",
               "Chinese", "youre", "present", "past", "Chinas", "China's", "India", "number", "Maria", "Although", 
               "studies","solar","energy","hence","third","section","study",
               "yesterday","comes","thank","earlier","came","doc","talk","tell","found","part","way",
               "thats","therefore","energies","yet","morning","done","theyre","bri","suggests","lets",
               "taking","believe","job","Chinese","China","trade", "think","know","much",
               "said","however","second","thus","country", "china", "market","industry","United","States","chinese","countries",
               stopwords("en"))

data_corpus <- VCorpus(VectorSource(tradedata$text))
data_corpus <- tm_map(data_corpus, removePunctuation)
data_corpus <- tm_map(data_corpus, content_transformer(tolower))
data_corpus <- tm_map(data_corpus, stripWhitespace)
data_corpus <- tm_map(data_corpus, removeWords, stopwords("english"))
data_corpus <- tm_map(data_corpus, removeWords, c(new_stops))
data_corpus <- tm_map(data_corpus, removeNumbers)

```

## Word Cloud 

```{r, message = FALSE, warning = FALSE, error=FALSE, echo=FALSE}

dtm <- DocumentTermMatrix(data_corpus)

word_freq <- colSums(as.matrix(dtm))

word_freq_df <- data.frame(word = names(word_freq), freq = word_freq)

wordcloud(words = word_freq_df$word, freq = word_freq_df$freq, min.freq = 5, max.words = 200,
          colors=c("red","blue"))

```
```{r, message = FALSE, warning = FALSE, error=FALSE, echo=FALSE}

ggsave("wordcloud_trade.png")



```


```{r, message = FALSE, warning = FALSE, echo=FALSE}

knitr::include_graphics("/Users/peizhi/Documents/GitHub/Group-I-Trade-between-China-and-the-US/wordcloud_trade.png")

```

